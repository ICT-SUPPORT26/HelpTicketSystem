<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}ICT Helpdesk System{% endblock %}</title>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark footer-sky">
        <div class="container-fluid px-3">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-headset me-2"></i>ICT Helpdesk
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('tickets_list') }}">
                            <i class="fas fa-ticket-alt me-1"></i>Tickets
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('new_ticket') }}">
                            <i class="fas fa-plus me-1"></i>New Ticket
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-file-alt me-1"></i>Reports
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('reports_management') }}"><i class="fas fa-folder-open me-2"></i>Manage Reports</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('analytics_dashboard') }}"><i class="fas fa-chart-line me-2"></i>Analytics</a></li>
                        </ul>
                    </li>
                    {% if current_user.role == 'admin' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog me-1"></i>Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li><h6 class="dropdown-header">Ticket Views</h6></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list') }}"><i class="fas fa-list me-2"></i>All Tickets</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list', status='open') }}"><i class="fas fa-clock me-2"></i>Open Tickets</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list', status='in_progress') }}"><i class="fas fa-spinner me-2"></i>In Progress</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list', status='resolved') }}"><i class="fas fa-check me-2"></i>Resolved</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list', status='closed') }}"><i class="fas fa-times me-2"></i>Closed</a></li>
                            <li><hr class="dropdown-divider"></li>

                            <!--
                            <li><h6 class="dropdown-header">Priority Views</h6></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list', priority='urgent') }}"><i class="fas fa-exclamation-triangle me-2"></i>Urgent</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list', priority='high') }}"><i class="fas fa-arrow-up me-2"></i>High</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list', priority='medium') }}"><i class="fas fa-minus me-2"></i>Medium</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('tickets_list', priority='low') }}"><i class="fas fa-arrow-down me-2"></i>Low</a></li>
                            <li><hr class="dropdown-divider"></li> -->
                            
                            <li><h6 class="dropdown-header">Management</h6></li>
                            <li><a class="dropdown-item" href="{{ url_for('user_management') }}"><i class="fas fa-users me-2"></i>User Management</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('analytics_dashboard') }}"><i class="fas fa-analytics me-2"></i>Analytics</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('reports') }}"><i class="fas fa-chart-bar me-2"></i>Reports</a></li>
                        </ul>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <!-- Theme Toggle (always visible) -->
                    <li class="nav-item me-3">
                        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme" title="Toggle dark/light mode">
                            <i class="fas fa-sun" id="theme-icon"></i>
                        </button>
                    </li>
                    {% if current_user.is_authenticated %}
                    
                    <!-- Notifications -->
                    <li class="nav-item dropdown me-3">
                        <a class="nav-link position-relative" href="#" id="notificationsDropdown" role="button" title="Notifications" aria-label="Notifications" 
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span id="notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                                0
                            </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationsDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <span>Notifications</span>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-link text-muted p-0" id="mark-all-read" style="font-size: 0.8rem;">
                                        Mark all read
                                    </button>
                                    <button class="btn btn-sm btn-link text-danger p-0" id="clear-all-notifications" style="font-size: 0.8rem;">
                                        Clear all
                                    </button>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <div id="notifications-list">
                                <li class="text-center py-3">
                                    <span class="text-muted">Loading notifications...</span>
                                </li>
                            </div>
                            <li><hr class="dropdown-divider"></li>
                            <li class="text-center">
                                <a href="{{ url_for('notification_settings') }}" class="dropdown-item text-center">
                                    <i class="fas fa-cog me-1"></i>Notification Settings
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i>{{ current_user.full_name }}
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('dashboard') }}"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
                            {% if current_user.role == 'admin' %}
                            <li><a class="dropdown-item" href="{{ url_for('user_management') }}"><i class="fas fa-users-cog me-2"></i>User Management</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('reports') }}"><i class="fas fa-chart-bar me-2"></i>Reports</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('analytics_dashboard') }}"><i class="fas fa-analytics me-2"></i>Analytics</a></li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('change_password') }}">
                                        <i class="fas fa-key me-2"></i>Change Password
                                    </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <main class="container-fluid my-4 px-3">
        {# Allow pages to suppress flashes by adding ?no_flash=1 to the URL (used after report upload/delete) #}
        {% if request.args.get('no_flash') != '1' %}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} fade-in" role="alert">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        {% else %}
            {# Consume flashed messages without rendering so they don't appear later on other pages. #}
            {% with _ = get_flashed_messages(with_categories=true) %}{% endwith %}
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    <!-- Toast container for transient notifications (appears top-right) -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>
    <footer class="footer-sky py-3 mt-5">
        <div class="container text-center">
            <span>&copy; {{ datetime.utcnow().year }} University of Nairobi ICT Helpdesk</span>
        </div>
    </footer>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Main JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <script>
        // Initialize notification manager only if user is authenticated
        document.addEventListener('DOMContentLoaded', function() {
            
            //{% if current_user.is_authenticated %}
            //try {
                //window.notificationManager = new NotificationManager();
                //console.log('Notification manager initialized successfully');
            //} catch (error) {
              //  console.error('Error initializing notification manager:', error);
            //}
           // {% endif %}

            // Add global error handler
           
            window.addEventListener('error', function(e) {
                console.error('Global JavaScript error:', e.error);
            });

            // Log page load
            console.log('Page loaded successfully:', window.location.pathname);

            // Convert any flashed alerts into Bootstrap toasts so they auto-hide
            (function() {
                try {
                    // If no Bootstrap, skip gracefully
                    if (typeof bootstrap === 'undefined') return;

                    const flashAlerts = document.querySelectorAll('main .alert');
                    if (!flashAlerts || flashAlerts.length === 0) return;

                    const tc = document.getElementById('toast-container') || (function(){
                        const d = document.createElement('div');
                        d.id = 'toast-container';
                        d.className = 'position-fixed top-0 end-0 p-3';
                        d.style.zIndex = 1080;
                        document.body.appendChild(d);
                        return d;
                    })();

                    flashAlerts.forEach(alert => {
                        // Determine category to style toast background
                        let category = 'info';
                        alert.classList.forEach(c => { if (c.startsWith('alert-')) category = c.replace('alert-',''); });

                        const messageHtml = alert.innerHTML;
                        const toast = document.createElement('div');
                        toast.className = 'toast align-items-center text-bg-' + (['danger','warning','success','info'].includes(category) ? category : 'info');
                        toast.setAttribute('role','alert');
                        toast.setAttribute('aria-live','assertive');
                        toast.setAttribute('aria-atomic','true');
                        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${messageHtml}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
                        tc.appendChild(toast);

                        // Show toast and auto-hide using configured delay
                        try {
                            const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: TOAST_AUTOHIDE_MS });
                            bsToast.show();
                        } catch (e) {
                            console.debug('Toast creation failed', e);
                        }

                        // Remove original alert from the DOM
                        alert.remove();
                    });
                } catch (e) {
                    console.debug('Flash->toast conversion failed', e);
                }
            })();

          //  {% if current_user.is_authenticated %}
            // Auto-logout after inactivity (3 minutes)
          //  (function() {
            //    const IDLE_MS = 3 * 60 * 1000; // 3 minutes
            //    const TOAST_AUTOHIDE_MS = {{ TOAST_AUTOCLOSE_MS }}; // ms
            //    const SESSION_EXPIRY_TOAST_CLASS = "{{ SESSION_EXPIRY_TOAST_CLASS }}";
            //    const SESSION_EXPIRY_REDIRECT_MS = {{ SESSION_EXPIRY_REDIRECT_MS }}; // ms after showing toast to redirect
            //    let idleTimer;

             //   function sendKeepAlive() {
                    // Send a lightweight GET to refresh server-side last_activity
                //    fetch("{{ url_for('keepalive') }}", { method: 'GET', credentials: 'same-origin' })
               //         .catch(err => console.debug('Keepalive failed:', err));
             //   }

              //  function _showSessionExpiryToastAndRedirect() {
                    // Build a transient toast informing user of automatic logout
              //      try {
               //         const tc = document.getElementById('toast-container');
               //         if (!tc) return window.location.href = "{{ url_for('logout') }}"; // fallback

                //        const messageHtml = 'You have been logged out due to inactivity.';
                  //      const toast = document.createElement('div');
                        // Use configured class for visibility (e.g., 'text-bg-warning')
                    //    toast.className = `toast align-items-center ${SESSION_EXPIRY_TOAST_CLASS}`;
                   //     toast.setAttribute('role','alert');
                   //     toast.setAttribute('aria-live','assertive');
                   //     toast.setAttribute('aria-atomic','true');
                  //      toast.innerHTML = `<div class="d-flex"><div class="toast-body">${messageHtml}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;

                  //      tc.appendChild(toast);
                  //      const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: TOAST_AUTOHIDE_MS });
                  //      bsToast.show();

                        // After a short delay (configurable), redirect to logout to complete server-side session clear.
                  //      setTimeout(function() {
                  //          window.location.href = "{{ url_for('logout') }}";
                  //      }, SESSION_EXPIRY_REDIRECT_MS);

                 //   } catch (e) {
              //          console.debug('Session expiry toast failed, redirecting to logout directly.', e);
               //         window.location.href = "{{ url_for('logout') }}";
               //     }
             //   }

              //  function resetTimer() {
               //     clearTimeout(idleTimer);
                 //   sendKeepAlive();
                  //  idleTimer = setTimeout(function() {
                        // No activity for IDLE_MS -> show session-expiry toast then redirect
                  //      console.log('User idle timeout reached, showing expiry toast then redirecting to logout');
                 //       _showSessionExpiryToastAndRedirect();
                 //   }, IDLE_MS);
              //  }

             //   ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(function(evt) {
            //        window.addEventListener(evt, resetTimer, true);
             //   });

                // Start timer on initial load
            //    resetTimer();
          //  })();
           // {% endif %}
       });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>