{% extends "base.html" %}

{% block title %}Analytics Dashboard - ICT Helpdesk{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-analytics me-2"></i>Analytics Dashboard</h2>
    <a href="{{ url_for('reports') }}" class="btn btn-primary">
        <i class="fas fa-chart-bar me-2"></i>Full Reports
    </a>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-ticket-alt fa-3x mb-3"></i>
                <h2 data-stat="total-tickets">{{ total_tickets }}</h2>
                <p class="mb-0">Tickets This Month</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h2 data-stat="resolved-this-month">{{ resolved_this_month }}</h2>
                <p class="mb-0">Resolved This Month</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-3x mb-3"></i>
                <h2 data-stat="sla-percentage">{{ "%.1f"|format(sla_percentage) }}%</h2>
                <p class="mb-0">SLA Compliance</p>
                <small>(2-day target)</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-percentage fa-3x mb-3"></i>
                <h2 data-stat="resolution-rate">{{ "%.1f"|format((resolved_this_month / total_tickets * 100) if total_tickets > 0 else 0) }}%</h2>
                <p class="mb-0">Resolution Rate</p>
            </div>
        </div>
    </div>
</div>

<!-- Top Categories -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Top Issue Categories (Last 30 Days)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Ticket Count</th>
                                <th>Percentage</th>
                                <th>Visual</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in top_categories %}
                            <tr>
                                <td>{{ category.name }}</td>
                                <td>{{ category.count }}</td>
                                <td>{{ "%.1f"|format((category.count / total_tickets * 100) if total_tickets > 0 else 0) }}%</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ (category.count / total_tickets * 100) if total_tickets > 0 else 0 }}%">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="{{ url_for('reports', status='overdue') }}" class="btn btn-danger btn-lg w-100">
                            <i class="fas fa-exclamation-triangle me-2"></i>View Overdue Tickets
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('reports', days=7) }}" class="btn btn-info btn-lg w-100">
                            <i class="fas fa-calendar-week me-2"></i>Weekly Report
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('reports', status='open') }}" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-folder-open me-2"></i>Open Tickets
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('user_management') }}" class="btn btn-secondary btn-lg w-100">
                            <i class="fas fa-users me-2"></i>Manage Users
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Real-time analytics update function
    function updateAnalyticsStats() {
        fetch('/api/analytics-stats')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error in analytics data:', data.error);
                    return;
                }

                // Update stats cards with animation
                updateStatCard('total-tickets', data.total_tickets);
                updateStatCard('resolved-this-month', data.resolved_this_month);
                updateStatCard('sla-percentage', data.sla_percentage.toFixed(1) + '%');
                updateStatCard('resolution-rate', ((data.resolved_this_month / data.total_tickets * 100) || 0).toFixed(1) + '%');

                // Update top categories table
                updateTopCategories(data.top_categories, data.total_tickets);

                // Show last update time
                const lastUpdate = new Date(data.timestamp).toLocaleTimeString();
                updateStatusIndicator('Last updated: ' + lastUpdate, 'success');

                console.log('Analytics updated at:', lastUpdate);
            })
            .catch(error => {
                console.error('Error fetching analytics stats:', error);
                updateStatusIndicator('Update failed', 'danger');
            });
    }

    function updateStatCard(dataAttr, newValue) {
        const element = document.querySelector(`[data-stat="${dataAttr}"]`) || 
                        document.querySelector(`h2:contains("${dataAttr}")`);

        if (element) {
            const currentValue = element.textContent.trim();
            if (currentValue !== newValue.toString()) {
                // Add update animation
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'all 0.3s ease';
                element.style.color = '#28a745';
                element.textContent = newValue;

                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                    element.style.color = '';
                }, 300);
            }
        } else {
            // Fallback: find by content matching
            const allH2 = document.querySelectorAll('h2');
            allH2.forEach(h2 => {
                if (h2.parentElement && h2.parentElement.querySelector('.card-body')) {
                    const cardText = h2.parentElement.textContent.toLowerCase();
                    if (cardText.includes(dataAttr.replace('-', ' '))) {
                        if (h2.textContent !== newValue.toString()) {
                            h2.style.transform = 'scale(1.1)';
                            h2.style.color = '#28a745';
                            h2.textContent = newValue;
                            setTimeout(() => {
                                h2.style.transform = 'scale(1)';
                                h2.style.color = '';
                            }, 300);
                        }
                    }
                }
            });
        }
    }

    function updateTopCategories(categories, totalTickets) {
        const tbody = document.querySelector('.table tbody');
        if (tbody && categories.length > 0) {
            tbody.innerHTML = categories.map(category => {
                const percentage = totalTickets > 0 ? (category.count / totalTickets * 100) : 0;
                return `
                    <tr>
                        <td>${category.name}</td>
                        <td>${category.count}</td>
                        <td>${percentage.toFixed(1)}%</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${percentage}%">
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }

    function updateStatusIndicator(message, type) {
        let indicator = document.getElementById('analytics-status');
        if (!indicator) {
            indicator = document.createElement('span');
            indicator.id = 'analytics-status';
            indicator.className = 'badge ms-2';
            const header = document.querySelector('h2');
            if (header) header.appendChild(indicator);
        }

        indicator.className = `badge ms-2 bg-${type}`;
        indicator.textContent = message;

        if (type === 'success') {
            setTimeout(() => {
                indicator.classList.remove('bg-success');
                indicator.classList.add('bg-secondary');
                indicator.textContent = 'Live Updates Active';
            }, 2000);
        }
    }

    // Start real-time updates every 3 seconds
    setInterval(updateAnalyticsStats, 3000);
    updateAnalyticsStats(); // Initial call

    // Add live indicator to header
    setTimeout(() => {
        updateStatusIndicator('Live Updates Active', 'secondary');
    }, 1000);
});
</script>

{% endblock %}